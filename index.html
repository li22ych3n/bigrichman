<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç·šä¸Šå¤§å¯Œç¿</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        :root { --p1-color: #e17055; --p2-color: #0984e3; --cell-size: 85px; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #dfe6e9; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #setup-screen, #game-screen { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 550px; text-align: center; }
        #game-screen { display: none; }
        .board { display: grid; grid-template-columns: repeat(6, var(--cell-size)); grid-template-rows: repeat(6, var(--cell-size)); gap: 5px; background: #2d3436; padding: 10px; border-radius: 10px; margin-bottom: 20px; }
        .cell { background: white; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; position: relative; text-align: center; height: var(--cell-size); }
        .start { background: #ff7675 !important; color: white; }
        .player { width: 30px; height: 30px; border-radius: 50%; position: absolute; border: 2px solid white; z-index: 10; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        button { padding: 12px 25px; background: #0984e3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 5px; }
        button:disabled { background: #b2bec3; cursor: not-allowed; }
        .admin-area { margin-top: 20px; padding-top: 20px; border-top: 2px dashed #ccc; background: #fff5f5; border-radius: 10px; }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center; }
        .modal-content { background:white; padding:30px; border-radius:15px; width:400px; text-align:center; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h2>ğŸ²ç·šä¸Šå¤§å¯Œç¿</h2>
        <div>
            <input type="text" id="user-name" placeholder="è¼¸å…¥æš±ç¨±" style="padding:10px; width:200px;">
            <div style="margin: 15px 0;">
                <button onclick="joinGame('p1')" id="btn-p1">æ“”ä»»ç©å®¶ 1 (ç´…)</button>
                <button onclick="joinGame('p2')" id="btn-p2">æ“”ä»»ç©å®¶ 2 (è—)</button>
            </div>
            <p id="room-status" style="color:gray;">æ­£åœ¨é€£ç·šè‡³ä¼ºæœå™¨...</p>
        </div>

        <div class="admin-area">
            <p>ğŸ› ï¸ <b>ç®¡ç†å“¡åˆå§‹åŒ–å€</b></p>
            <input type="file" id="csv-file" accept=".csv"><br><br>
            <button onclick="adminReset()" style="background:#2d3436;">åˆå§‹åŒ–/é‡è¨­éŠæˆ²é¡Œåº«</button>
        </div>
    </div>

    <div id="game-screen">
        <div id="board" class="board"></div>
        <div style="display:flex; justify-content: space-around;">
            <div id="p1-info" style="padding:10px; border-bottom:5px solid var(--p1-color)">P1</div>
            <button id="roll-btn" onclick="handleRoll()">æ“²éª°å­</button>
            <div id="p2-info" style="padding:10px; border-bottom:5px solid var(--p2-color)">P2</div>
        </div>
    </div>

    <div id="quiz-modal" class="modal">
        <div class="modal-content">
            <h3 id="quiz-q">é¡Œç›®è¼‰å…¥ä¸­</h3>
            <button onclick="submitAns(1)" id="opt1" style="width:100%">é¸é … 1</button>
            <button onclick="submitAns(2)" id="opt2" style="width:100%">é¸é … 2</button>
        </div>
    </div>

    <script>
        // Firebase é…ç½® (è«‹ä¿æŒä½ çš„åŸæ¨£)
        const firebaseConfig = {
            apiKey: "AIzaSyANdx-dIT_TDrIqYgSCOwLwHnl5dfRgd1M",
            authDomain: "monopolyonline-e202d.firebaseapp.com",
            projectId: "monopolyonline-e202d",
            databaseURL: "https://monopolyonline-e202d-default-rtdb.firebaseio.com",
            storageBucket: "monopolyonline-e202d.firebasestorage.app",
            messagingSenderId: "812568712440",
            appId: "1:812568712440:web:d2f1c5bfefa869c6ead70d"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let myRole = "", gameData = null;
        const cellMapping = ["6/1","5/1","4/1","3/1","2/1","1/1","1/2","1/3","1/4","1/5","1/6","2/6","3/6","4/6","5/6","6/6","6/5","6/4","6/3","6/2"];

        // --- é—œéµï¼šå…¨åŸŸç›£æ§å™¨ ---
        db.ref('room1').on('value', (snap) => {
            gameData = snap.val();
            if (!gameData) return;

            const setupScreen = document.getElementById('setup-screen');
            const gameScreen = document.getElementById('game-screen');
            const statusText = document.getElementById('room-status');

            // 1. åŒæ­¥é¡Œåº«ç‹€æ…‹
            if (!gameData.quiz) {
                statusText.innerText = "â³ ç­‰å¾…ç®¡ç†å“¡åˆå§‹åŒ–é¡Œåº«...";
                setupScreen.style.display = 'block';
                gameScreen.style.display = 'none';
            } else {
                // 2. é¡Œåº«å·²å­˜åœ¨ï¼Œæ ¹æ“šã€Œæˆ‘æ˜¯å¦å·²é¸è§’ã€æ±ºå®šç•«é¢
                if (!myRole) {
                    setupScreen.style.display = 'block';
                    gameScreen.style.display = 'none';
                    statusText.innerText = "âœ… é¡Œåº«å·²ç”±ç®¡ç†å“¡åŒæ­¥ï¼Œè«‹é¸è§’é€²å…¥éŠæˆ²";
                    
                    // åŒæ­¥æŒ‰éˆ•ç‹€æ…‹ï¼šå¦‚æœæœ‰äººé¸äº†ï¼Œå…¶ä»–äººå°±ä¸èƒ½å†æŒ‰
                    document.getElementById('btn-p1').disabled = gameData.p1?.active;
                    document.getElementById('btn-p2').disabled = gameData.p2?.active;
                    
                    // åŒæ­¥éš±è—ç®¡ç†å“¡æ§åˆ¶å€ï¼ˆåªæœ‰æœªé¸è§’å‰èƒ½çœ‹åˆ°ï¼Œä¸Šå‚³å¾Œæ¶ˆå¤±ï¼‰
                    document.querySelector('.admin-area').style.display = 'none';
                } else {
                    // 3. æˆ‘å·²é¸è§’ï¼šå¼·åˆ¶é€²å…¥éŠæˆ²ç•«é¢
                    setupScreen.style.display = 'none';
                    gameScreen.style.display = 'block';
                    initBoard(); // ç¢ºä¿æ£‹ç›¤ç¹ªè£½
                    updateUI();  // ç¢ºä¿ç©å®¶ä½ç½®ã€é‡‘é¡åŒæ­¥
                }
            }
        });

        function adminReset() {
            const file = document.getElementById('csv-file').files[0];
            if (!file) return alert("è«‹å…ˆé¸å– CSVï¼");
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split(/\r?\n/).filter(l => l.trim() !== "");
                const startIndex = (lines[0].includes("é¡Œç›®")) ? 1 : 0;
                const quiz = lines.slice(startIndex).map(line => {
                    const p = line.split(',').map(s => s.replace(/^"|"$/g, '').trim());
                    return { q: p[0], ans: parseInt(p[1]) || 1, o1: p[2], o2: p[3] };
                }).filter(i => i.q);

                // é‡è¨­æ•´å€‹æˆ¿é–“ï¼Œé€™æœƒè§¸ç™¼æ‰€æœ‰äººçš„ç•«é¢æ›´æ–°
                db.ref('room1').set({
                    status: 'ready',
                    quiz: quiz,
                    turn: 'p1',
                    p1: { name: "", pos: 0, money: 20000, active: false },
                    p2: { name: "", pos: 0, money: 20000, active: false }
                });
                alert("é¡Œåº«å·²ä¸Šå‚³ä¸¦åŒæ­¥è‡³é›²ç«¯ï¼");
            };
            reader.readAsText(file, "UTF-8");
        }

        function joinGame(role) {
            const name = document.getElementById('user-name').value;
            if (!name) return alert("è«‹è¼¸å…¥æš±ç¨±");
            myRole = role;
            db.ref(`room1/${role}`).update({ name: name, active: true });
            // ä¸éœ€è¦æ‰‹å‹•åˆ‡æ› displayï¼Œä¸Šé¢çš„ .on('value') æœƒè‡ªå‹•å¹«æˆ‘å€‘åˆ‡æ›
        }

        function initBoard() {
            const board = document.getElementById('board');
            board.innerHTML = "";
            for(let i=0; i<20; i++){
                const c = document.createElement('div');
                c.className = 'cell ' + (i===0?'start':'');
                c.style.gridArea = cellMapping[i];
                c.id = 'cell-'+i;
                c.innerText = i===0?"èµ·é»":"é—œå¡"+i;
                board.appendChild(c);
            }
        }

        function updateUI() {
            document.querySelectorAll('.player').forEach(e => e.remove());
            ['p1','p2'].forEach((k, idx) => {
                const p = gameData[k];
                const cell = document.getElementById('cell-'+p.pos);
                if(cell) {
                    const el = document.createElement('div');
                    el.className = 'player';
                    el.style.backgroundColor = k==='p1'?'var(--p1-color)':'var(--p2-color)';
                    el.innerText = p.name ? p.name[0] : "";
                    if(idx===1) el.style.bottom="2px"; else el.style.top="2px";
                    cell.appendChild(el);
                }
                document.getElementById(k+'-info').innerText = `${p.name}: $${p.money}`;
            });
            document.getElementById('roll-btn').disabled = (gameData.turn !== myRole);
        }

        function handleRoll() {
            const steps = Math.floor(Math.random()*6)+1;
            const newPos = (gameData[myRole].pos + steps) % 20;
            db.ref(`room1/${myRole}`).update({ pos: newPos });
            setTimeout(() => {
                const q = gameData.quiz[Math.floor(Math.random()*gameData.quiz.length)];
                window.currentAns = q.ans;
                document.getElementById('quiz-q').innerText = q.q;
                document.getElementById('opt1').innerText = q.o1;
                document.getElementById('opt2').innerText = q.o2;
                document.getElementById('quiz-modal').style.display = 'flex';
            }, 600);
        }

        function submitAns(c) {
            document.getElementById('quiz-modal').style.display = 'none';
            const reward = (c === window.currentAns) ? 3000 : -1000;
            alert(c === window.currentAns ? "æ­£ç¢ºï¼+$3000" : "éŒ¯èª¤ï¼-$1000");
            db.ref(`room1/${myRole}`).update({ money: gameData[myRole].money + reward });
            db.ref('room1').update({ turn: myRole==='p1'?'p2':'p1' });
        }
    </script>
</body>
</html>