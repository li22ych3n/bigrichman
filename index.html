<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å¤§å¯Œç¿</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        :root { --p1-color: #e17055; --p2-color: #0984e3; --cell-size: 90px; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #dfe6e9; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #setup-screen, #game-screen { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 550px; text-align: center; }
        #game-screen { display: none; width: auto; }
        .board { display: grid; grid-template-columns: repeat(6, var(--cell-size)); grid-template-rows: repeat(6, var(--cell-size)); gap: 5px; background: #2d3436; padding: 10px; border-radius: 10px; }
        .cell { background: white; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; position: relative; text-align: center; }
        .start { background: #ff7675 !important; color: white; }
        .player { width: 35px; height: 35px; border-radius: 50%; position: absolute; border: 2px solid white; z-index: 10; display: flex; align-items: center; justify-content: center; color: white; transition: 0.6s; font-weight: bold; font-size: 14px; }
        .dashboard { margin-top: 20px; display: flex; justify-content: space-between; gap: 15px; }
        .p-box { flex: 1; padding: 15px; border-radius: 10px; background: #f1f2f6; border-left: 10px solid #ccc; text-align: left; }
        .active-p { border-left-color: #00b894; background: #e8fcf9; }
        button { padding: 12px 25px; background: #0984e3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #b2bec3; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 400px; text-align: center; }
        .opt-btn { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #0984e3; border-radius: 10px; background: white; font-weight: bold; cursor: pointer; }
        .admin-area { margin-top: 20px; padding-top: 20px; border-top: 2px dashed #ccc; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h2 id="room-title">ğŸ² é€²å…¥å°æˆ°æˆ¿é–“</h2>
        
        <div id="player-area">
            <label><b>è«‹è¼¸å…¥ä½ çš„æš±ç¨±ï¼š</b></label>
            <input type="text" id="user-name" placeholder="ä¾‹å¦‚ï¼šç©å®¶ A" style="width:100%; padding:10px; margin-top:10px; border:1px solid #ddd; border-radius:5px;">
            <div style="margin: 15px 0;">
                <button onclick="joinGame('p1')" id="btn-p1" style="background:var(--p1-color)">æ“”ä»»ç©å®¶ 1 (ç´…)</button>
                <button onclick="joinGame('p2')" id="btn-p2" style="background:var(--p2-color)">æ“”ä»»ç©å®¶ 2 (è—)</button>
            </div>
            <p id="room-status" style="font-size:12px; color:gray;">ç­‰å¾…ç®¡ç†å“¡åˆå§‹åŒ–...</p>
        </div>

        <div class="admin-area">
            <p style="color:red; font-size:14px;">ğŸ› ï¸ <b>ç®¡ç†å“¡æ§åˆ¶ (ç”±ä½ æ“ä½œ)</b></p>
            <input type="file" id="csv-file" accept=".csv" style="font-size:12px;"><br><br>
            <button onclick="adminReset()" style="background:#2d3436; font-size:12px; padding:5px 10px;">åˆå§‹åŒ–/é‡è¨­éŠæˆ²é¡Œåº«</button>
        </div>
    </div>

    <div id="game-screen">
        <div id="board" class="board"></div>
        <div class="dashboard">
            <div id="p1-info" class="p-box">ç­‰å¾… P1...</div>
            <button id="roll-btn" onclick="handleRoll()">æ“²éª°å­</button>
            <div id="p2-info" class="p-box">ç­‰å¾… P2...</div>
        </div>
        <div id="status-msg" style="margin-top: 15px; font-weight: bold;"></div>
    </div>

    <div id="quiz-modal" class="modal">
        <div class="modal-content">
            <h3 id="quiz-q">é¡Œç›®</h3>
            <button class="opt-btn" id="opt1" onclick="submitAns(1)">é¸é … 1</button>
            <button class="opt-btn" id="opt2" onclick="submitAns(2)">é¸é … 2</button>
        </div>
    </div>

    <script>
   
        import { initializeApp } from "firebase/app";
        import { getAnalytics } from "firebase/analytics";

        const firebaseConfig = {
        apiKey: "AIzaSyANdx-dIT_TDrIqYgSCOwLwHnl5dfRgd1M",
        authDomain: "monopolyonline-e202d.firebaseapp.com",
        projectId: "monopolyonline-e202d",
        storageBucket: "monopolyonline-e202d.firebasestorage.app",
        messagingSenderId: "812568712440",
        appId: "1:812568712440:web:d2f1c5bfefa869c6ead70d",
        measurementId: "G-1SKX15SPK0"
        };

 
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        // ------------------------------

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let myRole = ""; 
        let gameData = null;
        const cellMapping = ["6/1","5/1","4/1","3/1","2/1","1/1","1/2","1/3","1/4","1/5","1/6","2/6","3/6","4/6","5/6","6/6","6/5","6/4","6/3","6/2"];

        // ç›£æ§æˆ¿é–“ç‹€æ…‹
        db.ref('room1').on('value', (snap) => {
            gameData = snap.val();
            const statusText = document.getElementById('room-status');
            const btn1 = document.getElementById('btn-p1');
            const btn2 = document.getElementById('btn-p2');

            if (!gameData || !gameData.quiz) {
                statusText.innerText = "âš ï¸ ç®¡ç†å“¡å°šæœªä¸Šå‚³é¡Œåº«ï¼Œè«‹ç¨å€™...";
                btn1.disabled = btn2.disabled = true;
            } else {
                statusText.innerText = "âœ… éŠæˆ²å·²å°±ç·’ï¼Œè«‹é¸æ“‡è§’è‰²é€²å…¥";
                btn1.disabled = (gameData.p1 && gameData.p1.active);
                btn2.disabled = (gameData.p2 && gameData.p2.active);
                if (gameData.status === 'playing' && myRole !== "") {
                    updateUI();
                }
            }
        });

        // ç®¡ç†å“¡åŠŸèƒ½ï¼šä¸Šå‚³ CSV ä¸¦æ¸…ç©ºèˆŠè³‡æ–™
        function adminReset() {
            const file = document.getElementById('csv-file').files[0];
            if (!file) { alert("è«‹å…ˆé¸æ“‡ CSV æª”æ¡ˆï¼"); return; }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const rows = e.target.result.split('\n').filter(r => r.trim() !== "");
                const startIdx = rows[0].includes("é¡Œç›®") ? 1 : 0;
                const quiz = rows.slice(startIdx).map(r => {
                    const c = r.split(',');
                    return { q: c[0], ans: parseInt(c[1]), o1: c[2], o2: c[3] };
                });

                db.ref('room1').set({
                    status: 'ready',
                    turn: 'p1',
                    p1: { name: "ç­‰å¾…ä¸­", pos: 0, money: 20000, active: false },
                    p2: { name: "ç­‰å¾…ä¸­", pos: 0, money: 20000, active: false },
                    quiz: quiz
                });
                alert("ç®¡ç†å“¡ï¼šé¡Œåº«ä¸Šå‚³å®Œæˆï¼ç¾åœ¨ç©å®¶å¯ä»¥é€²å…¥äº†ã€‚");
            };
            reader.readAsText(file);
        }

        // ç©å®¶åŠŸèƒ½ï¼šè¼¸å…¥å§“åä¸¦åŠ å…¥
        function joinGame(role) {
            const myName = document.getElementById('user-name').value;
            if (!myName) { alert("è«‹å…ˆè¼¸å…¥æš±ç¨±ï¼"); return; }
            
            myRole = role;
            db.ref(`room1/${role}`).update({
                name: myName,
                active: true
            });
            db.ref('room1').update({ status: 'playing' });

            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            initBoard();
        }

        // ... ä»¥ä¸‹ç‚ºéŠæˆ²é‚è¼¯ (èˆ‡å‰ç‰ˆç›¸åŒ) ...
        function initBoard() {
            const board = document.getElementById('board');
            board.innerHTML = "";
            for(let i=0; i<20; i++){
                const c = document.createElement('div');
                c.className = 'cell ' + (i===0 ? 'start' : '');
                c.style.gridArea = cellMapping[i];
                c.innerText = i === 0 ? "èµ·é»" : i;
                c.id = 'cell-' + i;
                board.appendChild(c);
            }
        }

        function updateUI() {
            document.querySelectorAll('.player').forEach(el => el.remove());
            ['p1', 'p2'].forEach((pKey, idx) => {
                const p = gameData[pKey];
                const cell = document.getElementById('cell-' + p.pos);
                if(cell) {
                    const el = document.createElement('div');
                    el.className = 'player';
                    el.style.backgroundColor = pKey === 'p1' ? 'var(--p1-color)' : 'var(--p2-color)';
                    el.innerText = p.name ? p.name[0] : "?";
                    if (idx === 1) el.style.bottom = "5px"; else el.style.top = "5px";
                    cell.appendChild(el);
                }
                const info = document.getElementById(`${pKey}-info`);
                info.innerHTML = `<b>${p.name}</b><br>ğŸ’° $${p.money}`;
                info.className = (gameData.turn === pKey) ? "p-box active-p" : "p-box";
            });
            const isMyTurn = (gameData.turn === myRole);
            document.getElementById('roll-btn').disabled = !isMyTurn;
            document.getElementById('status-msg').innerText = isMyTurn ? "ğŸŒŸ è¼ªåˆ°ä½ äº†ï¼" : `â³ ç­‰å¾… ${gameData[gameData.turn].name}...`;
        }

        function handleRoll() {
            const steps = Math.floor(Math.random() * 6) + 1;
            const newPos = (gameData[myRole].pos + steps) % 20;
            db.ref(`room1/${myRole}`).update({ pos: newPos });
            
            setTimeout(() => {
                if (newPos === 0) {
                    alert("å›åˆ°èµ·é»ï¼Œé ˜å–è–ªè³‡ $2000ï¼");
                    db.ref(`room1/${myRole}`).update({ money: gameData[myRole].money + 2000 });
                    switchTurn();
                } else {
                    const q = gameData.quiz[Math.floor(Math.random() * gameData.quiz.length)];
                    window.currentAns = q.ans;
                    document.getElementById('quiz-q').innerText = q.q;
                    document.getElementById('opt1').innerText = "1. " + q.o1;
                    document.getElementById('opt2').innerText = "2. " + q.o2;
                    document.getElementById('quiz-modal').style.display = 'flex';
                }
            }, 600);
        }

        function submitAns(choice) {
            document.getElementById('quiz-modal').style.display = 'none';
            if (choice === window.currentAns) {
                alert("æ­£ç¢ºï¼çé‡‘ $3000");
                db.ref(`room1/${myRole}`).update({ money: gameData[myRole].money + 3000 });
            } else {
                alert("éŒ¯èª¤ï¼ç½°æ¬¾ $1000");
                db.ref(`room1/${myRole}`).update({ money: gameData[myRole].money - 1000 });
            }
            switchTurn();
        }

        function switchTurn() {
            db.ref('room1').update({ turn: myRole === 'p1' ? 'p2' : 'p1' });
        }
    </script>
</body>
</html>